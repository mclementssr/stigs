---
- name: "MEDIUM | V-71863 | The operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a command line user logon."
  #copy:
  template: 
    #src=roles/stigs/rhel/7/templates/issue
    src=templates/issue
    dest=/etc/issue
    owner=root
    group=root
    mode=0644
    #backup=yes
  tags:
      - cat2
      - medium
      - RHEL-07-010050
      - SV-86487r1_rule
      - V-71863

- name: "MEDIUM | V-71895 | Check if /etc/dconf/db/local.d/locks directory exists."
  stat: path=/etc/dconf/db/local.d/locks
  register: v_71895_check
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010080
      - SV-86519r3_rule
      - V-71895

- name: "MEDIUM | V-71895 | Create /etc/dconf/db/local.d/locks directory if it doesn't exists."
  file:
      path: /etc/dconf/db/local.d/locks
      state: directory
      owner: root
      group: root
      mode: 0750
  when: v_71895_check.stat.exists == False
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010080
      - SV-86519r3_rule
      - V-71895

- name: "MEDIUM | V-71895 | Check if /etc/dconf/db/local.d/locks/session exists."
  stat: path=/etc/dconf/db/local.d/locks/session
  register: v_71895_check2
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010080
      - SV-86519r3_rule
      - V-71895

- name: "MEDIUM | V-71895 | Create /etc/dconf/db/local.d/locks/session if it doesn't exists."
  file:
      path: /etc/dconf/db/local.d/locks/session
      state: touch
      owner: root
      group: root
      mode: 0750
  when: v_71895_check2.stat.exists == False
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010080
      - SV-86519r3_rule
      - V-71895

- name: "MEDIUM | V-71895 | Check if /etc/dconf/db/local.d/locks/session exists."
  stat: path=/etc/dconf/db/local.d/locks/session
  register: v_71895_check3
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010080
      - SV-86519r3_rule
      - V-71895

- name: "MEDIUM | V-71895 | The operating system must initiate a session lock after a 15-minute period of inactivity for all connection types."
  lineinfile:
      state: present
      dest: /etc/dconf/db/local.d/locks/session
      regexp: '/org/gnome/desktop/screensaver/idle-delay'
      line: '/org/gnome/desktop/screensaver/idle-delay'
  when: v_71895_check3.stat.exists == True
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010080
      - SV-86519r3_rule
      - V-71895

- name: "MEDIUM | V-71897 | The operating system must have the screen package installed."
  yum:
    name: screen
    state: latest
  tags:
      - cat2
      - medium
      - RHEL-07-010090
      - SV-86521r1_rule
      - V-71897

- name: "MEDIUM | V-71903 | When passwords are changed or new passwords are established, the new password must contain at least one upper-case character."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: ucredit = *
    line: ucredit = -1
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010120
      - SV-86527r2_rule
      - V-71903

- name: "MEDIUM | V-71905 | When passwords are changed or new passwords are established, the new password must contain at least one lower-case character."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: lcredit = *
    line: lcredit = -1
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010130
      - SV-86529r2_rule
      - V-71905

- name: "MEDIUM | V-71907 | When passwords are changed or new passwords are assigned, the new password must contain at least one numeric character."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: dcredit = *
    line: dcredit = -1
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010140
      - SV-86531r2_rule
      - V-71907

- name: "MEDIUM | V-71909 | When passwords are changed or new passwords are assigned, the new password must contain at least one special character."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: ocredit = *
    line: ocredit = -1
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010150
      - SV-86533r1_rule
      - V-71909

- name: "MEDIUM | V-71911 | When passwords are changed a minimum of eight of the total number of characters must be changed."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: difok = *
    line: difok = 8
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010160
      - SV-86535r1_rule
      - V-71911

- name: "MEDIUM | V-71913 | When passwords are changed a minimum of four character classes must be changed."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: minclass = *
    line: minclass = 4
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010170
      - SV-86537r1_rule
      - V-71913

- name: "MEDIUM | V-71915 | When passwords are changed the number of repeating consecutive characters must not be more than four characters."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: maxrepeat = *
    line: maxrepeat = 2
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010180
      - SV-86539r1_rule
      - V-71915

- name: "MEDIUM | V-71917 | When passwords are changed the number of repeating characters of the same character class must not be more than four characters."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: maxclassrepeat = *
    line: maxclassrepeat = 4
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010190
      - SV-86541r1_rule
      - V-71917

#- name: "MEDIUM | V-71919 | Check if sha512 exist in /etc/pam.d/system-auth-ac."
#  shell: grep password /etc/pam.d/system-auth-ac | grep sha512
#  register: v_71919_check
#  #failed_when: true
#  ignore_errors: True
#  tags:
#      - cat2
#      - medium
#      - RHEL-07-0102000
#      - SV-86543r1_rule
#      - V-71919

- name: "MEDIUM | V-71919 | The PAM system service must be configured to store only encrypted representations of passwords."
  script: v-71919.sh
#  shell: sed -i.bak '/^[ ]*password[ ]*sufficient[ ]*pam_unix.so/ c\password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok' /etc/pam.d/system-auth-ac
#  when: v_71919_check|failed
  tags:
      - cat2
      - medium
      - RHEL-07-0102000
      - SV-86543r1_rule
      - V-71919

- name: "MEDIUM | V-71921 | The shadow file must be configured to store only encrypted representations of passwords."
  lineinfile:
    state: present
    dest: /etc/login.defs
    regexp: ENCRYPT_METHOD *
    line: ENCRYPT_METHOD SHA512
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010210
      - SV-86545r1_rule
      - V-71921

- name: "MEDIUM | V-71923 | User and group account administration utilities must be configured to store only encrypted representations of passwords."
  lineinfile:
    state: present
    dest: /etc/libuser.conf
    regexp: crypt_style = *
    line: crypt_style = sha512
    insertafter: '\[defaults\]'
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010220
      - SV-86547r2_rule
      - V-71923

- name: "MEDIUM | V-71925 | Passwords for new users must be restricted to a 24 hours/1 day minimum lifetime."
  lineinfile:
    state: present
    dest: /etc/login.defs
    regexp: 'PASS_MIN_DAYS *'
    line: 'PASS_MIN_DAYS   1'
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010230
      - SV-86549r1_rule
      - V-71925

- name: "MEDIUM | V-71927 | Passwords must be restricted to a 24 hours/1 day minimum lifetime."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-010240
      - SV-86551r1_rule
      - V-71927

- name: "MEDIUM | V-71929 | Passwords for new users must be restricted to a 60-day maximum lifetime."
  lineinfile:
    state: present
    dest: /etc/login.defs
    regexp: 'PASS_MAX_DAYS *'
    line: 'PASS_MAX_DAYS   60'
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010250
      - SV-86553r1_rule
      - V-71929

- name: "MEDIUM | V-71931 | Existing passwords must be restricted to a 60-day maximum lifetime."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-010260
      - SV-86555r1_rule
      - V-71931

- name: "MEDIUM | V-71933 | Passwords must be prohibited from reuse for a minimum of five generations."
  #command: "true"
  script: v-71933.sh
  tags:
      - cat2
      - medium
      - RHEL-07-010270
      - SV-86557r1_rule
      - V-71933

- name: "MEDIUM | V-71935 | Passwords must be a minimum of 15 characters in length."
  lineinfile:
    state: present
    dest: /etc/security/pwquality.conf
    regexp: 'minlen = *'
    line: 'minlen = 15'
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010280
      - SV-86559r1_rule
      - V-71935

- name: "MEDIUM | V-71941 | The operating system must disable account identifiers (individuals, groups, roles, and devices) if the password expires."
  lineinfile:
    state: present
    dest: /etc/default/useradd
    regexp: 'INACTIVE=*'
    line: 'INACTIVE=0'
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010310
      - SV-86565r1_rule
      - V-71941

- name: "MEDIUM | V-71943 | Accounts subject to three unsuccessful login attempts within 15 minutes must be locked for the maximum configurable period."
  #command: "true"
  script: v-71943.sh
  tags:
      - cat2
      - medium
      - RHEL-07-010320
      - SV-86567r1_rule
      - V-71943

- name: "MEDIUM | V-71945 | If three unsuccessful root logon attempts within 15 minutes occur the associated account must be locked."
  #command: "true"
  script: v-71945.sh
  tags:
      - cat2
      - medium
      - RHEL-07-010330
      - SV-86569r1_rule
      - V-71945

- name: "MEDIUM | V-71947 | Users must provide a password for privilege escalation."
  command: "true"
  #replace:
  #  dest: /etc/sudoers
  #  regexp: 'NOPASSWD ?'
  #  replace: ''
  #  #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010340
      - SV-86571r1_rule
      - V-71947

- name: "MEDIUM | V-71949 | Users must re-authenticate for privilege escalation."
  command: "true"
  #replace:
  #  dest: /etc/sudoers
  #  regexp: '(?i)^#?Authenticate'
  #  replace: ''
  tags:
      - cat2
      - medium
      - RHEL-07-010350
      - SV-86573r1_rule
      - V-71949

- name: "MEDIUM | V-71951 | The delay between logon prompts following a failed console logon attempt must be at least four seconds."
  lineinfile:
    state: present
    dest: /etc/login.defs
    regexp: 'FAIL_DELAY *'
    line: 'FAIL_DELAY 4'
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010430
      - SV-86575r1_rule
      - V-71951

- name: "MEDIUM | V-71957 | The operating system must not allow users to override SSH environment variables."
  lineinfile:
    state: present
    dest: /etc/ssh/sshd_config
    regexp: '^#?PermitUserEnvironment *'
    line: 'PermitUserEnvironment no'
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010460
      - SV-86581r2_rule
      - V-71957

- name: "MEDIUM | V-71959 | The operating system must not allow a non-certificate trusted host SSH logon to the system."
  lineinfile:
    state: present
    dest: /etc/ssh/sshd_config
    regexp: '^#?HostbasedAuthentication *'
    line: 'HostbasedAuthentication no'
    #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-010470
      - SV-86583r2_rule
      - V-71959

- name: "MEDIUM | V-71965 | The operating system must uniquely identify and must authenticate organizational users (or processes acting on behalf of organizational users) using multi-factor authentication."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-010500
      - SV-86589r2_rule
      - V-71965

- name: "MEDIUM | V-71971 | The operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020020
      - SV-86595r1_rule
      - V-71971

- name: "MEDIUM | V-71973 | Verify if installed or install Aide."
  yum:
     name: aide
     state: latest
  tags:
      - cat2
      - medium
      - RHEL-07-020030
      - SV-86597r1_rule
      - V-71973

- name: "MEDIUM | V-71973 | Create /etc/cron.daily/aide file if it doesn't exists."
  file:
      path: /etc/cron.daily/aide
      state: touch
      owner: root
      group: root
      mode: 0700
  ignore_errors: "{{ ansible_check_mode }}"
  tags:
      - cat2
      - medium
      - RHEL-07-020030
      - SV-86597r1_rule
      - V-71973

- name: "MEDIUM | V-71973 | A file integrity tool must verify the baseline operating system configuration at least weekly."
  lineinfile:
      dest: /etc/cron.daily/aide
      state: present
      regexp: '0 0 * * * /usr/sbin/aide --check | /bin/mail -s "aide integrity check run for " '
      line: '0 0 * * * /usr/sbin/aide --check | /bin/mail -s "aide integrity check run for " root@sysname.mil'
      #backup: yes
  ignore_errors: "{{ ansible_check_mode }}"
  tags:
      - cat2
      - medium
      - RHEL-07-020030
      - SV-86597r1_rule
      - V-71973

- name: "MEDIUM | V-71975 | Verify if installed or install Aide."
  yum:
     name: aide
     state: latest
  tags:
      - cat2
      - medium
      - RHEL-07-020040
      - SV-86599r1_rule
      - V-71975

- name: "MEDIUM | V-71975 | Designated personnel must be notified if baseline configurations are changed in an unauthorized manner."
  lineinfile:
      dest: /etc/cron.daily/aide
      state: present
      regexp: '0 0 * * * /usr/sbin/aide --check | /bin/mail -s "aide integrity check run for " '
      line: '0 0 * * * /usr/sbin/aide --check | /bin/mail -s "aide integrity check run for " root@sysname.mil'
      #backup: yes
  ignore_errors: "{{ ansible_check_mode }}"
  tags:
      - cat2
      - medium
      - RHEL-07-020040
      - SV-86599r1_rule
      - V-71975

#- name: "MEDIUM | V-71983 | Create /etc/modprobe.d/nousbstorage if it doesn't exist."
- name: "MEDIUM | V-71983 | Create /etc/modprobe.d/blacklist.conf if it doesn't exist."
  file:
      path: /etc/modprobe.d/blacklist.conf
      state: touch
      owner: root
      group: root
      mode: 0640
  tags:
      - cat2
      - medium
      - RHEL-07-020100
      - SV-86607r1_rule
      - V-71983

- name: "MEDIUM | V-71983 | USB mass storage must be disabled."
  lineinfile:
      dest: /etc/modprobe.d/blacklist.conf
      state: present
      regexp: 'blacklist usb-storage'
      line: 'blacklist usb-storage'
  ignore_errors: "{{ ansible_check_mode }}"
  tags:
      - cat2
      - medium
      - RHEL-07-020100
      - SV-86607r1_rule
      - V-71983

# V-71985 has it's own disable_autofs.yml file.

- name: "MEDIUM | V-71995 | The operating system must define default permissions for all authenticated users in such a way that the user can only read and modify their own files."
  lineinfile:
      state: present
      dest: /etc/login.defs
      regexp: 'UMASK *'
      line: 'UMASK 077'
      #backup: yes
  tags:
      - cat2
      - medium
      - RHEL-07-020240
      - SV-86619r1_rule
      - V-71995

- name: "MEDIUM | V-71999 | Vendor packaged system security patches and updates must be installed and up to date."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020260
      - SV-86623r3_rule
      - V-71999

- name: "MEDIUM | V-72001 | The system must not have unnecessary accounts. Example: User games"
  user:
      name: games
      state: absent
      #remove: yes # Not required because games doesn't have a home directory.
  tags:
      - cat2
      - medium
      - RHEL-07-020270
      - SV-86625r1_rule
      - V-72001

#- name: "MEDIUM | V-72001 | The system must not have unnecessary accounts. Example: Group games"
#  group:
#      name: games
#      state: absent
#  tags:
#      - cat2
#      - medium
#      - RHEL-07-020270
#      - SV-86625r1_rule
#      - V-72001

- name: "MEDIUM | V-72001 | The system must not have unnecessary accounts. Example: User ftp"
  user:
      name: ftp
      state: absent
      remove: yes # Not required because games doesn't have a home directory.
  tags:
      - cat2
      - medium
      - RHEL-07-020270
      - SV-86625r1_rule
      - V-72001

- name: "MEDIUM | V-72001 | The system must not have unnecessary accounts. Example: Group ftp"
  group:
      name: ftp
      state: absent
  tags:
      - cat2
      - medium
      - RHEL-07-020270
      - SV-86625r1_rule
      - V-72001

- name: "MEDIUM | V-72007 | All files and directories must have a valid owner."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020320
      - SV-86631r1_rule
      - V-72007


- name: "MEDIUM | V-72009 | All files and directories must have a valid group owner."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020330
      - SV-86633r1_rule
      - V-72009

- name: "MEDIUM | V-72011 | All local interactive users must have a home directory assigned in the /etc/passwd file."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020600
      - SV-86635r1_rule
      - V-72011

- name: "MEDIUM | V-72013 | All local interactive user accounts, upon creation, must be assigned a home directory."
  lineinfile:
      state: present
      dest: /etc/login.defs
      regexp: 'CREATE_HOME *'
      line: 'CREATE_HOME yes'
  tags:
      - cat2
      - medium
      - RHEL-07-020610
      - SV-86637r1_rule
      - V-72013

- name: "MEDIUM | V-72015 | All local interactive user home directories defined in the /etc/passwd file must exist."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020620
      - SV-86639r1_rule
      - V-72015

- name: "MEDIUM | V-72017 | All local interactive user home directories must have mode 0750 or less permissive."
  shell: "chmod 750 /home/*"
  tags:
      - cat2
      - medium
      - RHEL-07-020630
      - SV-86641r1_rule
      - V-72017

- name: "MEDIUM | V-72019 | All local interactive user home directories must be owned by their respective users."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020640
      - SV-86643r2_rule
      - V-72019

- name: "MEDIUM | V-72021 | All local interactive user home directories must be group-owned by the home directory owners primary group."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020650
      - SV-86645r2_rule
      - V-72021

- name: "MEDIUM | V-72023 | All files and directories contained in local interactive user home directories must be owned by the owner of the home directory."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020660
      - SV-86647r1_rule
      - V-72023

- name: "MEDIUM | V-72025 | All files and directories contained in local interactive user home directories must be group-owned by a group of which the home directory owner is a member."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020670
      - SV-86649r1_rule
      - V-72025

- name: "MEDIUM | V-72027 | All files and directories contained in local interactive user home directories must have mode 0750 or less permissive."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020680
      - SV-86651r1_rule
      - V-72027

- name: "MEDIUM | V-72029 | All local initialization files for interactive users must be owned by the home directory user or root."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020690
      - SV-86653r1_rule
      - V-72029

- name: "MEDIUM | V-72031 | Local initialization files for local interactive users must be group-owned by the users primary group or root."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020700
      - SV-86655r2_rule
      - V-72031

- name: "MEDIUM | V-72033 | All local initialization files must have mode 0740 or less permissive."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020710
      - SV-86657r1_rule
      - V-72033

- name: "MEDIUM | V-72035 | All local interactive user initialization files executable search paths must contain only absolute paths."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020720
      - SV-86659r2_rule
      - V-72035

- name: "MEDIUM | V-72037 | Local initialization files must not execute world-writable programs."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020730
      - SV-86661r1_rule
      - V-72037

- name: "MEDIUM | V-72039 | All system device files must be correctly labeled to prevent unauthorized modification."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-020900
      - SV-86663r1_rule
      - V-72039

- name: "MEDIUM | V-72041 | Files systems that contain user home directories must be mounted to prevent files with the setuid and setgid bit set from being executed."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-021000
      - SV-86665r2_rule
      - V-72041

- name: "MEDIUM | V-72043 | Files systems that are used with removable media must be mounted to prevent files with the setuid and setgid bit set from being executed."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-021010
      - SV-86667r1_rule
      - V-72043

- name: "MEDIUM | V-72045 | Files systems that are being imported via Network File System (NFS) must be mounted to prevent files with the setuid and setgid bit set from being executed."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-021020
      - SV-86669r1_rule
      - V-72045

- name: "MEDIUM | V-72047 | All world-writable directories must be group-owned by root, sys, bin, or an application group."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-021030
      - SV-86671r1_rule
      - V-72047

- name: "MEDIUM | V-72049 | The umask must be set to 077 for all local interactive user accounts. /etc/bashrc"
  shell: sed -i.bak 's/\(mask \)0.*/\mask 077/g' /etc/bashrc
  tags:
      - cat2
      - medium
      - RHEL-07-021040
      - SV-86673r1_rule
      - V-72049

- name: "MEDIUM | V-72049 | The umask must be set to 077 for all local interactive user accounts. /etc/profile"
  shell: sed -i.bak 's/\(mask \)0.*/\mask 077/g' /etc/profile
  tags:
      - cat2
      - medium
      - RHEL-07-021040
      - SV-86673r1_rule
      - V-72049

#- name: "MEDIUM | V-72051 | Check if cron.log exist in /etc/rsyslog."
#  shell: grep cron.log /etc/rsyslog.conf 
#  register: v_72051_check
#  ignore_errors: True
#  tags:
#      - cat2
#      - medium
#      - RHEL-07-021100
#      - SV-86675r1_rule
#      - V-72051

- name: "MEDIUM | V-72051 | Cron logging must be implemented."
#  replace: 
#      dest: /etc/rsyslog.conf
#      regexp: '/var/log/cron'
#      replace: '/var/log/cron.log'
  script: v-72051.sh
  notify: restart rsyslog
#  when: v_72051_check|failed
  tags:
      - cat2
      - medium
      - RHEL-07-021100
      - SV-86675r1_rule
      - V-72051

- name: "MEDIUM | V-72053 | If the cron.allow file exists it must be owned by root."
  stat: path=/etc/cron.allow
  register: v_72053_check
  tags:
      - cat2
      - medium
      - RHEL-07-021110
      - SV-86677r1_rule
      - V-72053

- name: "MEDIUM | V-72053 | If the cron.allow file exists it must be owned by root."
  file:
      path: /etc/cron.allow
      owner: root
  when: v_72053_check.stat.exists == True
  tags:
      - cat2
      - medium
      - RHEL-07-021110
      - SV-86677r1_rule
      - V-72053

- name: "MEDIUM | V-72055 | If the cron.allow file exists it must be group-owned by root."
  stat: path=/etc/cron.allow
  register: v_72055_check
  tags:
      - cat2
      - medium
      - RHEL-07-021120
      - SV-86679r1_rule
      - V-72055

- name: "MEDIUM | V-72055 | If the cron.allow file exists it must be group-owned by root."
  file:
      path: /etc/cron.allow
      group: root
  when: v_72055_check.stat.exists == True
  tags:
      - cat2
      - medium
      - RHEL-07-021120
      - SV-86679r1_rule
      - V-72055

- name: "MEDIUM | V-72057 | Kernel core dumps must be disabled unless needed."
  service:
      name: kdump
      enabled: no
      state: stopped
  tags:
      - cat2
      - medium
      - RHEL-07-021300
      - SV-86681r1_rule
      - V-72057

- name: "MEDIUM | V-72073 | Install AIDE."
  yum: 
      name: aide
      state: present
  tags:
      - cat2
      - medium
      - RHEL-07-021620
      - SV-86687r2_rule
      - V-72073

- name: "MEDIUM | V-72073 | Check if /etc/aide.conf exists."
  stat: path=/etc/aide.conf
  register: v_72073_check
  tags:
      - cat2
      - medium
      - RHEL-07-021620
      - SV-86687r2_rule
      - V-72073

- name: "MEDIUM | V-72073 | The file integrity tool must use FIPS 140-2 approved cryptographic hashes for validating file contents and directories."
  script: v-72073.sh
  when: v_72073_check.stat.exists == True
  tags:
      - cat2
      - medium
      - RHEL-07-021620
      - SV-86687r2_rule
      - V-72073

- name: "MEDIUM | V-72075 | The system must not allow removable media to be used as the boot loader unless approved."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-021700
      - SV-86699r1_rule
      - V-72075

# DON'T ENABLE. This will prevent auditd from starting.
#- name: "MEDIUM | V-72081 | The operating system must shut down upon audit processing failure, unless availability is an overriding concern. If availability is a concern, the system must alert the designated staff (System Administrator [SA] and Information System Security Officer [ISSO] at a minimum) in the event of an audit processing failure."
#  lineinfile:
#    dest: /etc/audit/auditd.conf
#    regexp: auditctl -f *
#    line: auditctl -f 1
#    state: present
#    #backup: yes
#  tags:
#      - cat2
#      - medium
#      - RHEL-07-030010
#      - SV-86705r1_rule
#      - V-72081

- name: "MEDIUM | V-72083 | Check if /etc/audisp/audisp-remote.conf exists."
  stat: path=/etc/audisp/audisp-remote.conf
  register: v_72083_check
  tags:
      - cat2
      - medium
      - RHEL-07-030300
      - SV-86707r1_rule
      - V-72083

- name: "MEDIUM | V-72083 | Create /etc/audisp/audisp-remote.conf."
  file:
    path: /etc/audisp/audisp-remote.conf
    state: touch
    owner: root
    group: root
    mode: 0644
  when: v_72083_check.stat.exists == false
  tags:
      - cat2
      - medium
      - RHEL-07-030300
      - SV-86707r1_rule
      - V-72083

- name: "MEDIUM | V-72083 | Check if /etc/audisp/audisp-remote.conf exists."
  stat: path=/etc/audisp/audisp-remote.conf
  register: v_72083_check_2
  tags:
      - cat2
      - medium
      - RHEL-07-030300
      - SV-86707r1_rule
      - V-72083

- name: "MEDIUM | V-72083 | The operating system must off-load audit records onto a different system or media from the system being audited."
  lineinfile:
      dest: /etc/audisp/audisp-remote.conf
      regexp: remote_server = *
      line: remote_server = 0.0.0.0
  when: v_72083_check_2.stat.exists == True
  tags:
      - cat2
      - medium
      - RHEL-07-030300
      - SV-86707r1_rule
      - V-72083

- name: "MEDIUM | V-72085 | Check if /etc/audisp/audisp-remote.conf exists."
  stat: path=/etc/audisp/audisp-remote.conf
  register: v_72085_check
  tags:
      - cat2
      - medium
      - RHEL-07-030310
      - SV-86709r1_rule
      - V-72085

- name: "MEDIUM | V-72085 | Create /etc/audisp/audisp-remote.conf."
  file:
    path: /etc/audisp/audisp-remote.conf
    state: touch
    owner: root
    group: root
    mode: 0644
  when: v_72085_check.stat.exists == false
  tags:
      - cat2
      - medium
      - RHEL-07-030310
      - SV-86709r1_rule
      - V-72085

- name: "MEDIUM | V-72085 | Check if /etc/audisp/audisp-remote.conf exists."
  stat: path=/etc/audisp/audisp-remote.conf
  register: v_72085_check_2
  tags:
      - cat2
      - medium
      - RHEL-07-030310
      - SV-86709r1_rule
      - V-72085

- name: "MEDIUM | V-72085 | The operating system must encrypt the transfer of audit records off-loaded onto a different system or media from the system being audited."
  #command: "true"
  lineinfile:
    dest: /etc/audisp/audisp-remote.conf
    regexp: enable_krb5 = *
    line: enable_krb5 = yes
    state: present
  when: v_72085_check_2.stat.exists == True
  tags:
      - cat2
      - medium
      - RHEL-07-030310
      - SV-86709r1_rule
      - V-72085

- name: "MEDIUM | V-72087 | Check if /etc/audisp/audisp-remote.conf exists."
  stat: path=/etc/audisp/audisp-remote.conf
  register: v_72087_check
  tags:
      - cat2
      - medium
      - RHEL-07-030320
      - SV-86711r2_rule
      - V-72087

- name: "MEDIUM | V-72087 | Create /etc/audisp/audisp-remote.conf."
  file:
    path: /etc/audisp/audisp-remote.conf
    state: touch
    owner: root
    group: root
    mode: 0644
  when: v_72087_check.stat.exists == false
  tags:
      - cat2
      - medium
      - RHEL-07-030320
      - SV-86711r2_rule
      - V-72087

- name: "MEDIUM | V-72087 | Check if /etc/audisp/audisp-remote.conf exists."
  stat: path=/etc/audisp/audisp-remote.conf
  register: v_72087_check_2
  tags:
      - cat2
      - medium
      - RHEL-07-030320
      - SV-86711r2_rule
      - V-72087

- name: "MEDIUM | V-72087 | The audit system must take appropriate action when the audit storage volume is full."
  lineinfile:
    dest: /etc/audisp/audisp-remote.conf
    regexp: disk_full_action = *
    line: disk_full_action = syslog
    state: present
  when: v_72087_check_2.stat.exists == True
  tags:
      - cat2
      - medium
      - RHEL-07-030320
      - SV-86711r2_rule
      - V-72087

- name: "MEDIUM | V-72087 | The audit system must take appropriate action when the audit storage volume is full."
  lineinfile:
    dest: /etc/audisp/audisp-remote.conf
    regexp: network_failure_action = *
    line: network_failure_action = syslog
    state: present
  when: v_72087_check_2.stat.exists == True
  tags:
      - cat2
      - medium
      - RHEL-07-030320
      - SV-86711r2_rule
      - V-72087

- name: "MEDIUM | V-72089 | The operating system must immediately notify the System Administrator (SA) and Information System Security Officer ISSO (at a minimum) when allocated audit record storage volume reaches 75% of the repository maximum audit record storage capacity."
  lineinfile:
      dest: /etc/audit/auditd.conf
      regexp: '^space_left = *'
      line: 'space_left = 3750000000'
  tags:
      - cat2
      - medium
      - RHEL-07-030330
      - SV-86713r1_rule
      - V-72089

- name: "MEDIUM | V-72091 | The operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) via email when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
      dest: /etc/audit/auditd.conf
      regexp: '^space_left_action = *'
      line: 'space_left_action = email'
  tags:
      - cat2
      - medium
      - RHEL-07-030340
      - SV-86715r1_rule
      - V-72091

- name: "MEDIUM | V-72093 | The operating system must immediately notify the System Administrator (SA) and Information System Security Officer (ISSO) (at a minimum) when the threshold for the repository maximum audit record storage capacity is reached."
  lineinfile:
      dest: /etc/audit/auditd.conf
      regexp: '^action_mail_acct = *'
      line: 'action_mail_acct = root'
  tags:
      - cat2
      - medium
      - RHEL-07-030350
      - SV-86717r2_rule
      - V-72093

- name: "MEDIUM | V-72095 | All privileged function executions must be audited."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-030360
      - SV-86719r2_rule
      - V-72095

- name: "Medium | \n
  V-72097, V-72099, V-72101, V-72103, V-72105, V-72107, V-72109, V-72111, V-72113, \n
  V-72115, V-72117, V-72119, V-72121, V-72123, V-72125, V-72127, V-72129, V-72131, \n
  V-72133, V-72135, V-72137, V-72139, V-72141, V-72143, V-72145, V-72147, V-72149, \n
  V-72151, V-72153, V-72155, V-72157, V-72159, V-72161, V-72163, V-72165, V-72167, \n
  V-72169, V-72171, V-72173, V-72175, V-72177, V-72179, V-72183, V-72185, V-72187, \n
  V-72189, V-72191, V-72193, V-72195, V-72197, V-72199, V-72201, V-72203, V-72205, \n
  V-72207, V-73165, V-73167, 73171, V-73173 \n 
  | Patch | Replaces audit.rules file. \n "
  template: 
      #src=stigs/rhel7/templates/audit_rules 
      src=audit_rules
      dest=/etc/audit/rules.d/audit.rules 
      owner=root 
      group=root 
      mode=0640 
      #backup=yes
  notify: restart auditd
  tags: 
      - cat2
      - medium
      - RHEL-07-030370
      - SV-86721r2_rule
      - V-72097
      - RHEL-07-030380
      - SV-86723r2_rule
      - V-72099
      - RHEL-07-030390
      - SV-86725r2_rule
      - V-72101
      - RHEL-07-030400
      - SV-86727r2_rule
      - V-72103
      - RHEL-07-030410
      - SV-86729r2_rule
      - V-72105
      - RHEL-07-030420
      - SV-86731r2_rule
      - V-72107
      - RHEL-07-030430
      - SV-86733r2_rule
      - V-72109
      - RHEL-07-030440
      - SV-86735r2_rule
      - V-72111
      - RHEL-07-030450
      - SV-86737r2_rule
      - V-72113
      - RHEL-07-030460
      - SV-86739r2_rule
      - V-72115
      - RHEL-07-030470
      - SV-86741r2_rule
      - V-72117
      - RHEL-07-030480
      - SV-86743r2_rule
      - V-72119
      - RHEL-07-030490
      - SV-86745r2_rule
      - V-72121
      - RHEL-07-030500
      - SV-86747r2_rule
      - V-72123
      - RHEL-07-030510
      - SV-86749r2_rule
      - V-72125
      - RHEL-07-030520
      - SV-86751r2_rule
      - V-72127
      - RHEL-07-040530
      - SV-86753r2_rule
      - V-72129
      - RHEL-07-030540
      - SV-86755r2_rule
      - V-72131
      - RHEL-07-030550
      - SV-86757r2_rule
      - V-72133
      - RHEL-07-030560
      - SV-86759r3_rule
      - V-72135
      - RHEL-07-030570
      - SV-86761r3_rule
      - V-72137
      - RHEL-07-030580
      - SV-86763r3_rule
      - V-72139
      - RHEL-07-030590
      - SV-86765r3_rule
      - V-72141
      - RHEL-07-030600
      - SV-86767r2_rule
      - V-72143
      - RHEL-07-030610
      - SV-86769r2_rule
      - V-72145
      - RHEL-07-030620
      - SV-86771r2_rule
      - V-72147
      - RHEL-07-030630
      - SV-86773r3_rule
      - V-72149
      - RHEL-07-030640
      - SV-86775r3_rule
      - V-72151
      - RHEL-07-030650
      - SV-86777r3_rule
      - V-72153
      - RHEL-07-030660
      - SV-86779r3_rule
      - V-72155
      - RHEL-07-030670
      - SV-86781r3_rule
      - V-72157
      - RHEL-07-030680
      - SV-86783r3_rule
      - V-72159
      - RHEL-07-030690
      - SV-86785r3_rule
      - V-72161
      - RHEL-07-030700
      - SV-86787r3_rule
      - V-72163
      - RHEL-07-030710
      - SV-86789r3_rule
      - V-72165
      - RHEL-07-030720
      - SV-86791r3_rule
      - V-72167
      - RHEL-07-030730
      - SV-86793r3_rule
      - V-72169
      - SV-86795r3_rule
      - V-72171
      - RHEL-07-030750
      - SV-86797r3_rule
      - V-72173
      - RHEL-07-030760
      - SV-86799r3_rule
      - V-72175
      - RHEL-07-030770
      - SV-86801r2_rule
      - V-72177
      - RHEL-07-030780
      - SV-86803r2_rule
      - V-72179
      - RHEL-07-030790
      - SV-86805r2_rule
      - V-72183
      - RHEL-07-030810
      - SV-86809r2_rule
      - V-72185
      - RHEL-07-030820
      - SV-86811r2_rule
      - V-72187
      - RHEL-07-030830
      - SV-86813r2_rule
      - V-72189
      - RHEL-07-030840
      - SV-86815r2_rule
      - V-72191
      - RHEL-07-030850
      - SV-86817r2_rule
      - V-72193
      - RHEL-07-030860
      - SV-86819r2_rule
      - V-72195
      - RHEL-07-030870
      - SV-86821r3_rule
      - V-72197
      - RHEL-07-030880
      - SV-86823r2_rule
      - V-72199
      - RHEL-07-030890
      - SV-86825r2_rule
      - V-72201
      - RHEL-07-030900
      - SV-86827r2_rule
      - V-72203
      - RHEL-07-030910
      - SV-86829r2_rule
      - V-72205
      - RHEL-07-030920
      - SV-86831r2_rule
      - V-72207 
      - RHEL-07-030871
      - SV-87817r2_rule
      - V-73165
      - RHEL-07-030872
      - SV-87819r2_rule
      - V-73167
      - RHEL-07-030873
      - SV-87823r2_rule
      - V-73171
      - RHEL-07-030874
      - SV-87825r2_rule
      - V-73173

- name: "MEDIUM | V-72209 | The system must send rsyslog output to a log aggregation server."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-031000
      - SV-86833r1_rule
      - V-72209

- name: "MEDIUM | V-72211 | The rsyslog daemon must not accept log messages from other servers unless the server is being used for log aggregation."
  lineinfile: 
      dest: /etc/rsyslog.conf
      state: absent
      regexp: 'ModLoad imtcp'
  tags:
      - cat2
      - medium
      - RHEL-07-031010
      - SV-86835r1_rule
      - V-72211

- name: "MEDIUM | V-72215 | The system must update the DoD-approved virus scan program every seven days or more frequently."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-032010
      - SV-86839r1_rule
      - V-72215

- name: "MEDIUM | V-72219 | The host must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management Component Local Service Assessment (PPSM CLSA) and vulnerability assessments."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-040100
      - SV-86843r2_rule
      - V-72219

- name: "MEDIUM | V-72221 | A FIPS 140-2 approved cryptographic algorithm must be used for SSH communications."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: (?i)^#?Ciphers
      line: Ciphers aes128-ctr,aes192-ctr,aes256-ctr
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040110
      - SV-86845r2_rule
      - V-72221

- name: "MEDIUM | V-72223 | All network connections associated with a communication session must be terminated at the end of the session or after 10 minutes of inactivity from the user at a command prompt, except to fulfill documented and validated mission requirements."
  lineinfile:
      dest: /etc/profile
      regexp: ^#?TMOUT
      line: TMOUT=600
  tags:
      - cat2
      - medium
      - RHEL-07-040160
      - SV-86847r2_rule
      - V-72223

- name: "MEDIUM | V-72225 | The Standard Mandatory DoD Notice and Consent Banner must be displayed immediately prior to, or as part of, remote access logon prompts."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: 'Banner'
      line: 'Banner /etc/issue'
  tags:
      - cat2
      - medium
      - RHEL-07-040170
      - SV-86849r2_rule
      - V-72225

- name: "MEDIUM | V-72227 | The operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) authentication communications."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-040180
      - SV-86851r2_rule
      - V-72227

- name: "MEDIUM | V-72229 | The operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) communications."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-040190
      - SV-86853r2_rule
      - V-72229

- name: "MEDIUM | V-72231 | The operating system must implement cryptography to protect the integrity of Lightweight Directory Access Protocol (LDAP) communications."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-040200
      - SV-86855r2_rule
      - V-72231

- name: "MEDIUM | V-72233 | All networked systems must have SSH installed."
  yum:
      name:
          - openssh-clients
          - openssh-server
      state: latest
  tags:
      - cat2
      - medium
      - RHEL-07-040300
      - SV-86857r1_rule
      - V-72233

- name: "MEDIUM | V-72235 | All networked systems must use SSH for confidentiality and integrity of transmitted and received information as well as information during preparation for transmission."
  service:
      name: sshd
      state: started
      enabled: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040310
      - SV-86859r2_rule
      - V-72235

- name: "MEDIUM | V-72237 | All network connections associated with SSH traffic must terminate at the end of the session or after 10 minutes of inactivity, except to fulfill documented and validated mission requirements."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: ^#?ClientAliveInterval
      line: ClientAliveInterval 600
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040320
      - SV-86861r2_rule
      - V-72237

- name: "MEDIUM | V-72239 | The SSH daemon must not allow authentication using RSA rhosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: ^#?RhostsRSAAuthentication
      line: RhostsRSAAuthentication yes
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040330
      - SV-86863r2_rule
      - V-72239

- name: "MEDIUM | V-72241 | All network connections associated with SSH traffic must terminate after a period of inactivity."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: ^#?ClientAliveCountMax
      line: ClientAliveCountMax 0
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040340
      - SV-86865r2_rule
      - V-72241

- name: "MEDIUM | V-72243 | The SSH daemon must not allow authentication using rhosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: ^#?IgnoreRhosts
      line: IgnoreRhosts yes
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040350
      - SV-86867r2_rule
      - V-72243

- name: "MEDIUM | V-72245 | The system must display the date and time of the last successful account logon upon an SSH logon."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: ^#?PrintLastLog
      line: PrintLastLog yes
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040360
      - SV-86869r2_rule
      - V-72245

- name: "MEDIUM | V-72247 | The system must not permit direct logons to the root account using remote access via SSH."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: ^#?PermitRootLogin
      line: PermitRootLogin no
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040370
      - SV-86871r2_rule
      - V-72247

- name: "MEDIUM | V-72249 | The SSH daemon must not allow authentication using known hosts authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: ^#?IgnoreUserKnownHosts
      line: IgnoreUserKnownHosts yes
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040380
      - SV-86873r2_rule
      - V-72249

- name: "MEDIUM | V-72253 | The SSH daemon must be configured to only use Message Authentication Codes (MACs) employing FIPS 140-2 approved cryptographic hash algorithms."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: (?i)^#?MACs
      line: MACs hmac-sha2-256,hmac-sha2-512
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040400
      - SV-86877r2_rule
      - V-72253

- name: "MEDIUM | V-72255 | The SSH public host key files must have mode 0644 or less permissive."
  shell: chmod 0644 /etc/ssh/*key.pub
  tags:
      - cat2
      - medium
      - RHEL-07-040410
      - SV-86879r1_rule
      - V-72255

- name: "MEDIUM | V-72257 | The SSH private host key files must have mode 0600 or less permissive."
  shell: chmod 0600 /etc/ssh/ssh_host*key
  tags:
      - cat2
      - medium
      - RHEL-07-040420
      - SV-86881r1_rule
      - V-72257

- name: "MEDIUM | V-72259 | The SSH daemon must not permit Generic Security Service Application Program Interface (GSSAPI) authentication unless needed."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: (?i)^#?gssapiauthentication
      line: GSSAPIAuthentication no
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040430
      - SV-86883r2_rule
      - V-72259

- name: "MEDIUM | V-72261 | The SSH daemon must not permit Kerberos authentication unless needed."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: (?i)^#?kerberosauthentication
      line: KerberosAuthentication no
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040440
      - SV-86885r2_rule
      - V-72261

- name: "MEDIUM | V-72263 | The SSH daemon must perform strict mode checking of home directory configuration files."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: (?i)^#?strictmodes
      line: StrictModes yes
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040450
      - SV-86887r2_rule
      - V-72263

- name: "MEDIUM | V-72265 | The SSH daemon must use privilege separation."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: (?i)^#?useprivilegeseparation
      line: UsePrivilegeSeparation yes
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040460
      - SV-86889r2_rule
      - V-72265

- name: "MEDIUM | V-72267 | The SSH daemon must not allow compression or must only allow compression after successful authentication."
  lineinfile:
      dest: /etc/ssh/sshd_config
      regexp: (?i)^#?compression
      line: Compression no
  notify: restart ssh
  tags:
      - cat2
      - medium
      - RHEL-07-040470
      - SV-86891r2_rule
      - V-72267

- name: "MEDIUM | V-72269 | Install ntpd"
  yum:
      name: ntp
      state: present
  tags:
      - cat2
      - medium
      - RHEL-07-040500
      - SV-86893r2_rule
      - V-72269

- name: "MEDIUM | V-72269 | Check if /etc/ntp.conf exists"
  stat: path=/etc/ntp.conf
  register: v_72269_check
  tags:
      - cat2
      - medium
      - RHEL-07-040500
      - SV-86893r2_rule
      - V-72269

- name: "MEDIUM | V-72269 | The operating system must, for networked systems, synchronize clocks with a server that is synchronized to one of the redundant United States Naval Observatory (USNO) time servers, a time server designated for the appropriate DoD network (NIPRNet/SIPRNet), and/or the Global Positioning System (GPS)."
  lineinfile:
      dest: /etc/ntp.conf
      regexp: ^#?maxpoll
      line: maxpoll 10
  notify: restart ntpd
  when: v_72269_check.stat.exists == true
  tags:
      - cat2
      - medium
      - RHEL-07-040500
      - SV-86893r2_rule
      - V-72269

- name: "MEDIUM | V-72271 | The operating system must protect against or limit the effects of Denial of Service (DoS) attacks by validating the operating system is implementing rate-limiting measures on impacted network interfaces."
  script: v-72271.sh 
  tags:
      - cat2
      - medium
      - RHEL-07-040510
      - SV-86895r1_rule
      - V-72271

- name: "MEDIUM | V-72273 | The system must use a local firewall. Install latest Firewalld"
  yum:
      name: firewalld
      state: latest
  tags:
      - cat2
      - medium
      - RHEL-07-040520
      - SV-86897r1_rule
      - V-72273

- name: "MEDIUM | V-72273 | The system must use a local firewall. Start Firewalld"
  service:
      name: firewalld
      state: started
      enabled: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040520
      - SV-86897r1_rule
      - V-72273

- name: "MEDIUM | V-72283 | The system must not forward Internet Protocol version 4 (IPv4) source-routed packets."
  sysctl:
      name: net.ipv4.conf.all.accept_source_route
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040610
      - SV-86907r1_rule
      - V-72283

- name: "MEDIUM | V-72285 | The system must not forward Internet Protocol version 4 (IPv4) source-routed packets by default."
  sysctl:
      name: net.ipv4.conf.default.accept_source_route
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040620
      - SV-86909r1_rule
      - V-72285

- name: "MEDIUM | V-72287 | The system must not respond to Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) echoes sent to a broadcast address."
  sysctl:
      name: net.ipv4.icmp_echo_ignore_broadcasts
      state: present
      value: 1
      sysctl_set: yes
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040630
      - SV-86911r1_rule
      - V-72287

- name: "MEDIUM | v-72289 | The system must ignore to Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages."
  sysctl:
      name: net.ipv4.conf.default.accept_redirects
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040640
      - SV-86913r2_rule
      - V-72289

- name: "MEDIUM | V-72291 | The system must not allow interfaces to perform Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects by default."
  sysctl:
      name: net.ipv4.conf.default.send_redirects
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040650
      - SV-86915r2_rule
      - V-72291

- name: "MEDIUM | V-72293 | The system must not send Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirects."
  sysctl:
      name: net.ipv4.conf.all.send_redirects
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040660
      - SV-86917r2_rule
      - V-72293

- name: "MEDIUM | V-72295 | Network interfaces must not be in promiscuous mode."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-040670
      - SV-86919r1_rule
      - V-72295

- name: "MEDIUM | V-72297 | Check if /etc/postfix/main.cf exists."
  stat: path=/etc/postfix/main.cf
  register: v_72297_check
  tags:
      - cat2
      - medium
      - RHEL-07-040680
      - SV-86921r2_rule
      - V-72297

- name: "MEDIUM | V-72297 | The system must be configured to prevent unrestricted mail relaying."
  lineinfile:
      dest: /etc/postfix/main.cf
      regexp: 'smtpd_client_restrictions = '
      line: 'smtpd_client_restrictions = permit_mynetworks, reject'
  when: v_72297_check.stat.exists == true
  tags:
      - cat2
      - medium
      - RHEL-07-040680
      - SV-86921r2_rule
      - V-72297

- name: "MEDIUM | V-72305 | Check if /etc/xinetd.d/tftp exists."
  stat: path=/etc/xinetd.d/tftp
  register: v_72305_check
  tags:
      - cat2
      - medium
      - RHEL-07-040720
      - SV-86929r1_rule
      - V-72305

- name: "MEDIUM | V-72305 | If the Trivial File Transfer Protocol (TFTP) server is required, the TFTP daemon must be configured to operate in secure mode."
  lineinfile:
      dest: /etc/xinetd.d/tftp
      regexp: 'server_args = '
      line: 'server_args = -s /var/lib/tftpboot'
  when: v_72305_check.stat.exists == true
  tags:
      - cat2
      - medium
      - RHEL-07-040720
      - SV-86929r1_rule
      - V-72305

# V-72307 X Windows has it's own remove_gui.yml

- name: "MEDIUM | V-72309 | The system must not be performing packet forwarding unless the system is a router."
  sysctl:
      name: net.ipv4.ip_forward
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040740
      - SV-86933r1_rule
      - V-72309

- name: "MEDIUM | V-72311 | The Network File System (NFS) must be configured to use RPCSEC_GSS."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-040750
      - SV-86935r3_rule
      - V-72311

- name: "MEDIUM | V-72315 | The system's access control program must be configured to grant or deny system access to specific hosts and services."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-040810
      - SV-86939r1_rule
      - V-72315

- name: "MEDIUM | V-72317 | The system must not have unauthorized IP tunnels configured."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-040820
      - SV-86941r1_rule
      - V-72317

- name: "MEDIUM | V-72319 | The system must not forward IPv6 source-routed packets."
  sysctl:
      name: net.ipv6.conf.all.accept_source_route
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040830
      - SV-86943r1_rule
      - V-72319

- name: "MEDIUM | V-72417 | The operating system must have the required packages for mulitfactor authentication installed."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-041001
      - SV-87041r2_rule
      - V-72417

- name: "MEDIUM | V-72427 | The operating system must implement mulitfactor authentication for access to privileged accounts via pluggable authentication modules (PAM)."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-041002
      - SV-87051r2_rule
      - V-72427

- name: "MEDIUM | V-72433 | The operating system must implement certificate status checking for PKI authentication."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-041003
      - SV-87057r2_rule
      - V-72433

- name: "MEDIUM | V-72435 | The operating system must implement smart card logons for multifactor authentication for access to privileged accounts."
  command: "true"
  tags:
      - cat2
      - medium
      - RHEL-07-041004
      - SV-87059r2_rule
      - V-72435

- name: "MEDIUM | V-73155 | Check if directory /etc/dconf/db/local.d/locks exist."
  stat: path=/etc/dconf/db/local.d/locks
  register: v_73155_check
  tags:
      - cat2
      - medium
      - RHEL-07-010081
      - SV-87807r2_rule
      - V-73155

- name: "MEDIUM | V-73155 | Create /etc/dconf/db/local.d/locks."
  file:
      path: /etc/dconf/db/local.d/locks
      state: directory
      owner: root
      group: root
      mode: 0750
  when: v_73155_check.stat.exists == False
  tags:
      - cat2
      - medium
      - RHEL-07-010081
      - SV-87807r2_rule
      - V-73155

- name: "MEDIUM | V-73155 | Check if /etc/dconf/db/local.d/locks/session exists."
  stat: path=/etc/dconf/db/local.d/locks/session
  register: v_73155_check2
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010081
      - SV-87807r2_rule
      - V-73155

- name: "MEDIUM | V-73155 | Create /etc/dconf/db/local.d/locks/session if it doesn't exists."
  file:
      path: /etc/dconf/db/local.d/locks/session
      state: touch
      owner: root
      group: root
      mode: 0750
  when: v_73155_check2.stat.exists == False
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010081
      - SV-87807r2_rule
      - V-73155

- name: "MEDIUM | V-73155 | Check if /etc/dconf/db/local.d/locks/session exists."
  stat: path=/etc/dconf/db/local.d/locks/session
  register: v_73155_check3
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010081
      - SV-87807r2_rule
      - V-73155

- name: "MEDIUM | V-73155 | The operating system must set the lock delay setting for all connection types."
  lineinfile:
      state: present
      dest: /etc/dconf/db/local.d/locks/session
      regexp: '/org/gnome/desktop/screensaver/lock-delay'
      line: '/org/gnome/desktop/screensaver/lock-delay'
  when: v_73155_check3.stat.exists == True
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010081
      - SV-87807r2_rule
      - V-73155

- name: "MEDIUM | V-73157 | Check if directory /etc/dconf/db/local.d/locks exist."
  stat: path=/etc/dconf/db/local.d/locks
  register: v_73157_check
  tags:
      - cat2
      - medium
      - RHEL-07-010082
      - SV-87809r2_rule
      - V-73157

- name: "MEDIUM | V-73157 | Create /etc/dconf/db/local.d/locks."
  file:
      path: /etc/dconf/db/local.d/locks
      state: directory
      owner: root
      group: root
      mode: 0750
  when: v_73157_check.stat.exists == False
  tags:
      - cat2
      - medium
      - RHEL-07-010082
      - SV-87809r2_rule
      - V-73157

- name: "MEDIUM | V-73157 | Check if /etc/dconf/db/local.d/locks/session exists."
  stat: path=/etc/dconf/db/local.d/locks/session
  register: v_73157_check2
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010082
      - SV-87809r2_rule
      - V-73157

- name: "MEDIUM | V-73157 | Create /etc/dconf/db/local.d/locks/session if it doesn't exists."
  file:
      path: /etc/dconf/db/local.d/locks/session
      state: touch
      owner: root
      group: root
      mode: 0750
  when: v_73157_check2.stat.exists == False
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010082
      - SV-87809r2_rule
      - V-73157

- name: "MEDIUM | V-73157 | Check if /etc/dconf/db/local.d/locks/session exists."
  stat: path=/etc/dconf/db/local.d/locks/session
  register: v_73157_check3
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010082
      - SV-87809r2_rule
      - V-73157

- name: "MEDIUM | V-73157 | The operating system must set the idle delay setting for all connection types."
  lineinfile:
      state: present
      dest: /etc/dconf/db/local.d/locks/session
      regexp: '/org/gnome/desktop/session/idle-delay'
      line: '/org/gnome/desktop/session/idle-delay'
  when: v_73157_check3.stat.exists == True
  tags:
      - cat2-gui
      - medium
      - RHEL-07-010082
      - SV-87809r2_rule
      - V-73157

- name: "MEDIUM | V-73159 | When passwords are changed or new passwords are established, pwquality must be used."
  script: v-73159.sh
  tags:
      - cat2
      - medium
      - RHEL-07-010119
      - SV-87811r2_rule
      - V-73159

- name: "MEDIUM | V-73161 | File systems that are being imported via Network File System (NFS) must be mounted to prevent binary files from being executed."
  command: "true"
  tags:
    - cat1
    - high
    - RHEL-07-021021
    - SV-87813r1_rule
    - V-73161

- name: "MEDIUM | V-73163 | Check if /etc/audisp/audisp-remote.conf exists."
  stat: path=/etc/audisp/audisp-remote.conf
  register: v_73163_check
  tags:
      - cat2
      - medium
      - RHEL-07-030321
      - SV-87815r2_rule
      - V-73163

- name: "MEDIUM | V-73163 | Create /etc/audisp/audisp-remote.conf."
  file:
    path: /etc/audisp/audisp-remote.conf
    state: touch
    owner: root
    group: root
    mode: 0644
  when: v_73163_check.stat.exists == false
  tags:
      - cat2
      - medium
      - RHEL-07-030321
      - SV-87815r2_rule
      - V-73163

- name: "MEDIUM | V-73163 | Check if /etc/audisp/audisp-remote.conf exists."
  stat: path=/etc/audisp/audisp-remote.conf
  register: v_73163_check_2
  tags:
      - cat2
      - medium
      - RHEL-07-030321
      - SV-87815r2_rule
      - V-73163

- name: "MEDIUM | V-73163 | The audit system must take appropriate action when there is an error sending audit records to a remote system."
  lineinfile:
      dest: /etc/audisp/audisp-remote.conf
      regexp: network_failure_action = *
      line: network_failure_action = syslog 
  when: v_73163_check_2.stat.exists == True
  tags:
      - cat2
      - medium
      - RHEL-07-030321
      - SV-87815r2_rule
      - V-73163

- name: "MEDIUM | V-73175 | The system must ignore Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages."
  sysctl:
      name: net.ipv4.conf.all.accept_redirects
      state: present
      value: 0
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040641
      - SV-87827r2_rule
      - V-73175

- name: "MEDIUM | V-73177 | Wireless network adapters must be disabled."
  command: nmcli radio wifi off
  tags:
      - cat2
      - medium
      - RHEL-07-041010
      - SV-87829r1_rule
      - V-73177

- name: "MEDIUM | V-77821 |  Create /etc/modprobe.d/nodccp if it doesn't exist."
  file:
      path: /etc/modprobe.d/nodccp
      state: touch
      owner: root
      group: root
      mode: 0640
  tags:
      - cat2
      - medium
      - RHEL-07-020101
      - SV-92517r1_rule
      - V-77821


- name: "MEDIUM | V-77821 | The Datagram Congestion Control Protocol (DCCP) kernel module must be disabled unless required."
  lineinfile:
      dest: /etc/modprobe.d/nodccp
      state: present
      regexp: 'install dccp'
      line: 'install dccp /bin/true'
  ignore_errors: "{{ ansible_check_mode }}"
  tags:
      - cat2
      - medium
      - RHEL-07-020101
      - SV-92517r1_rule
      - V-77821

- name: "MEDIUM | V-77823 | The operating system must require authentication upon booting into single-user and maintenance modes."
  lineinfile:
      dest: /usr/lib/systemd/system/rescue.service
      state: present
      regexp: 'ExecStart=-\/bin/sh -c'
      line: 'ExecStart=-/bin/sh -c "/usr/sbin/sulogin; /usr/bin/systemctl --fail --no-block default"'
      insertbefore: "Type=idle"
  tags:
      - cat2
      - medium
      - RHEL-07-010481
      - SV-92519r1_rule
      - V-77823

- name: "MEDIUM | V-77825 | The operating system must implement virtual address space randomization."
  sysctl:
      name: kernel.randomize_va_space
      state: present
      value: 2
      reload: yes
      ignoreerrors: yes
  tags:
      - cat2
      - medium
      - RHEL-07-040201
      - SV-92521r1_rule
      - V-77825

